apiVersion: batch/v1
kind: CronJob
metadata:
  name: history-flush
  namespace: etymograph
  labels:
    app: history-flush
spec:
  # Run every hour at minute 0
  schedule: "0 * * * *"
  # Keep last 3 successful and 1 failed job for debugging
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 1
  # Don't start a new job if the previous one is still running
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      # Auto-cleanup after 1 hour
      ttlSecondsAfterFinished: 3600
      template:
        metadata:
          labels:
            app: history-flush
        spec:
          containers:
            - name: history-flush
              image: ghcr.io/epikoding/etymograph-api-go:latest
              imagePullPolicy: IfNotPresent
              command: ["./history-flush"]
              envFrom:
                - configMapRef:
                    name: etymograph-config
                - secretRef:
                    name: etymograph-secrets
              resources:
                requests:
                  memory: "128Mi"
                  cpu: "100m"
                limits:
                  memory: "256Mi"
                  cpu: "500m"
          restartPolicy: OnFailure

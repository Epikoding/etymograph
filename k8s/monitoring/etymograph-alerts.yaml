# EtymoGraph 커스텀 알림 규칙
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: etymograph-alerts
  namespace: monitoring
  labels:
    release: prometheus
    app: kube-prometheus-stack
spec:
  groups:
    - name: etymograph.api
      rules:
        # API 서버 다운 (스크래핑 실패 또는 타겟 없음)
        - alert: EtymographAPIDown
          expr: up{job="api"} == 0 or absent(up{job="api"})
          for: 1m
          labels:
            severity: critical
          annotations:
            summary: "EtymoGraph API 서버가 다운되었습니다"
            description: "EtymoGraph API 서버가 1분 이상 응답하지 않습니다."

        # API 높은 에러율 (5xx 에러가 5% 이상)
        - alert: EtymographAPIHighErrorRate
          expr: |
            (
              sum(rate(http_requests_total{job="api", status=~"5.."}[5m])) /
              sum(rate(http_requests_total{job="api"}[5m]))
            ) > 0.05
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "EtymoGraph API 에러율 높음"
            description: "API 에러율이 5% 이상입니다. 현재: {{ $value | humanizePercentage }}"

        # API 느린 응답 (p95 > 2초)
        - alert: EtymographAPISlowResponse
          expr: |
            histogram_quantile(0.95,
              sum(rate(http_request_duration_seconds_bucket{job="api"}[5m])) by (le)
            ) > 2
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "EtymoGraph API 응답 속도 느림"
            description: "API p95 응답 시간이 2초를 초과합니다. 현재: {{ $value | humanizeDuration }}"

    - name: etymograph.llm-proxy
      rules:
        # LLM Proxy 다운 (스크래핑 실패 또는 타겟 없음)
        - alert: EtymographLLMProxyDown
          expr: up{job="llm-proxy"} == 0 or absent(up{job="llm-proxy"})
          for: 1m
          labels:
            severity: critical
          annotations:
            summary: "EtymoGraph LLM Proxy가 다운되었습니다"
            description: "LLM Proxy가 1분 이상 응답하지 않습니다."

        # LLM 요청 높은 에러율
        - alert: EtymographLLMHighErrorRate
          expr: |
            (
              sum(rate(llm_requests_total{job="llm-proxy", status=~"5.."}[5m])) /
              sum(rate(llm_requests_total{job="llm-proxy"}[5m]))
            ) > 0.1
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "LLM Proxy 에러율 높음"
            description: "LLM Proxy 에러율이 10% 이상입니다. 현재: {{ $value | humanizePercentage }}"

        # LLM 요청 느린 응답 (p95 > 30초)
        - alert: EtymographLLMSlowResponse
          expr: |
            histogram_quantile(0.95,
              sum(rate(llm_request_duration_seconds_bucket{job="llm-proxy"}[5m])) by (le)
            ) > 30
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "LLM Proxy 응답 속도 느림"
            description: "LLM Proxy p95 응답 시간이 30초를 초과합니다."

    - name: etymograph.pods
      rules:
        # Pod 재시작 반복
        - alert: EtymographPodRestartingTooMuch
          expr: |
            increase(kube_pod_container_status_restarts_total{namespace="etymograph"}[1h]) > 3
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "Pod가 자주 재시작됩니다"
            description: "{{ $labels.pod }}가 1시간 내 3회 이상 재시작되었습니다."

        # Pod 메모리 사용량 높음 (80% 이상)
        - alert: EtymographPodHighMemoryUsage
          expr: |
            (
              container_memory_working_set_bytes{namespace="etymograph", container!=""}
              / container_spec_memory_limit_bytes{namespace="etymograph", container!=""}
            ) > 0.8
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "Pod 메모리 사용량 높음"
            description: "{{ $labels.pod }}의 메모리 사용량이 80%를 초과합니다."

        # Pod CPU 사용량 높음 (80% 이상)
        - alert: EtymographPodHighCPUUsage
          expr: |
            (
              sum(rate(container_cpu_usage_seconds_total{namespace="etymograph", container!=""}[5m])) by (pod)
              / sum(container_spec_cpu_quota{namespace="etymograph", container!=""} / container_spec_cpu_period{namespace="etymograph", container!=""}) by (pod)
            ) > 0.8
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "Pod CPU 사용량 높음"
            description: "{{ $labels.pod }}의 CPU 사용량이 80%를 초과합니다."

    - name: etymograph.database
      rules:
        # PostgreSQL 다운 (Ready 상태가 아니거나 Pod가 없음)
        - alert: EtymographPostgresDown
          expr: |
            kube_pod_status_ready{namespace="etymograph", pod=~"postgres-.*", condition="true"} == 0
            or absent(kube_pod_status_ready{namespace="etymograph", pod=~"postgres-.*", condition="true"})
          for: 1m
          labels:
            severity: critical
          annotations:
            summary: "PostgreSQL이 다운되었습니다"
            description: "EtymoGraph PostgreSQL Pod가 Ready 상태가 아닙니다."

        # Redis 다운 (Ready 상태가 아니거나 Pod가 없음)
        - alert: EtymographRedisDown
          expr: |
            kube_pod_status_ready{namespace="etymograph", pod=~"redis-.*", condition="true"} == 0
            or absent(kube_pod_status_ready{namespace="etymograph", pod=~"redis-.*", condition="true"})
          for: 1m
          labels:
            severity: critical
          annotations:
            summary: "Redis가 다운되었습니다"
            description: "EtymoGraph Redis Pod가 Ready 상태가 아닙니다."

        # PVC 용량 부족 (80% 이상)
        - alert: EtymographPVCAlmostFull
          expr: |
            (
              kubelet_volume_stats_used_bytes{namespace="etymograph"}
              / kubelet_volume_stats_capacity_bytes{namespace="etymograph"}
            ) > 0.8
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "PVC 용량 부족"
            description: "{{ $labels.persistentvolumeclaim }} 사용량이 80%를 초과합니다."
